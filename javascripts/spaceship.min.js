function getRandomInt(e,n){return Math.floor(Math.random()*(n-e+1))+e}function colision(e,n){return e.x>n.x-20&&e.x<n.x+20&&e.y>n.y-20&&e.y<n.y+20}function drawTriangle(e,n,t,a,i){ctx.fillStyle=a,ctx.beginPath(),ctx.moveTo(e-t,n),ctx.lineTo(e,"up"===i?n-t:n+t),ctx.lineTo(e+t,n),ctx.lineTo(e-t,n),ctx.fill()}function paintStars(e){ctx.fillStyle="#000000",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#ffffff",e.forEach(function(e){ctx.fillRect(e.x,e.y,e.size,e.size)})}function paintSpaceShip(e,n){drawTriangle(e,n,20,"#ff0000","up")}function paintEnemies(e){e.forEach(function(e){e.y+=5,e.x+=getRandomInt(-15,15),e.isDead||drawTriangle(e.x,e.y,20,"#00ff00","down"),e.shots.forEach(function(e){e.y+=SHOOTING_SPEED,drawTriangle(e.x,e.y,5,"#00ffff","down")})})}function paintScore(e){ctx.fillStyle="#ffffff",ctx.font="bold 26px sans-serif",ctx.fillText("Score: "+e,40,43)}function isVisible(e){return e.x>-40&&e.x<canvas.width+40&&e.y>-40&&e.y<canvas.height+40}function paintHeroShots(e,n){e.forEach(function(e){for(var t=!1,a=0;a<n.length;a++){var i=n[a];if(!i.isDead&&colision(e,i)){ScoreSubject.onNext(SCORE_INCREASE),i.isDead=!0,e.x=e.y=-100,t=!0;break}}t||(e.y-=SHOOTING_SPEED,drawTriangle(e.x,e.y,5,"#ffff00","up"))})}function gameOver(e,n){return n.some(function(n){return colision(e,n)?!0:n.shots.some(function(n){return colision(e,n)})})}function renderScene(e){paintStars(e.stars),paintSpaceShip(e.spaceship.x,e.spaceship.y),paintEnemies(e.enemies),paintHeroShots(e.heroShots,e.enemies),paintScore(e.score)}var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");document.body.appendChild(canvas),canvas.width=window.innerWidth,canvas.height=window.innerHeight;var SPEED=40,SHOOTING_FREQ=250,SHOOTING_SPEED=15,ENEMY_FREQ=1500,ENEMY_SHOOTING_FREQ=750,SCORE_INCREASE=10,HERO_Y=canvas.height-30,playerShots=Rx.Observable.merge(Rx.Observable.fromEvent(canvas,"click"),Rx.Observable.fromEvent(document,"keydown").filter(function(e){return 32===e.keyCode})),StarStream=Rx.Observable.range(1,250).map(function(){return{x:parseInt(Math.random()*canvas.width),y:parseInt(Math.random()*canvas.height),size:3*Math.random()+1}}).toArray().flatMap(function(e){return Rx.Observable.interval(SPEED).map(function(){return e.map(function(e){return e.y>=canvas.height&&(e.y=0),e.y+=3,e})})}),mouseMove=Rx.Observable.fromEvent(canvas,"mousemove"),SpaceShip=mouseMove.map(function(e){return{x:e.clientX,y:HERO_Y}}).startWith({x:canvas.width/2,y:HERO_Y}),playerFiring=playerShots.startWith({}).sample(200).timestamp(),HeroShots=Rx.Observable.combineLatest(playerFiring,SpaceShip,function(e,n){return{timestamp:e.timestamp,x:n.x}}).distinct(function(e){return e.timestamp}).scan(function(e,n){return e.push({x:n.x,y:HERO_Y}),e.filter(isVisible)},[]),Enemies=Rx.Observable.interval(ENEMY_FREQ).scan(function(e){var n={x:parseInt(Math.random()*canvas.width),y:-30,shots:[]};return Rx.Observable.interval(ENEMY_SHOOTING_FREQ).subscribe(function(){n.isDead||n.shots.push({x:n.x,y:n.y}),n.shots=n.shots.filter(isVisible)}),e.concat(n).filter(function(e){return isVisible(e)&&!(e.isDead&&0===e.shots.length)})},[]),ScoreSubject=new Rx.Subject,score=ScoreSubject.scan(function(e,n){return e+n},0).startWith(0),Game=Rx.Observable.combineLatest(StarStream,SpaceShip,Enemies,HeroShots,score,function(e,n,t,a,i){return{stars:e,spaceship:n,enemies:t,heroShots:a,score:i}}).sample(SPEED).takeWhile(function(e){var n=gameOver(e.spaceship,e.enemies);return n===!0&&e.enemies.forEach(function(e){e.isDead=!0}),n===!1});Game.subscribe(renderScene);
